<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Presentation Timer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #4CAF50; /* Green color */
            color: #FFFFFF;
            text-align: center;
        }

        #timerText {
            font-size: 72px;
            margin: 0;
        }

        #overtimeText {
            font-size: 36px;
            margin: 0;
            display: none;
        }

        #progressBar {
            width: 100%;
            height: 20px;
            margin-top: 20px;
        }

        .btn-icon {
            background-color: transparent;
            border: none;
            padding: 0;
        }

        .btn-icon img {
            width: 50px;
            height: 50px;
        }

        #aboutButton {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            border: none;
            padding: 0;
        }

        #aboutButton img {
            width: 30px;
            height: 30px;
        }

        .form-control {
            font-size: 24px;
            text-align: center;
        }

        label {
            font-size: 18px;
            margin-top: 10px;
        }

        /* Adjust padding for mobile devices */
        @media (max-width: 576px) {
            #timerText {
                font-size: 48px;
            }

            #overtimeText {
                font-size: 24px;
            }

            .btn-icon img {
                width: 40px;
                height: 40px;
            }

            .form-control {
                font-size: 20px;
            }

            label {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid d-flex flex-column align-items-center justify-content-center vh-100">
        <button id="aboutButton" class="btn-icon">
            <img src="ic_info.png" alt="About">
        </button>

        <div id="inputs" class="mb-4 w-100 px-3">
            <div class="mb-3">
                <label for="totalTime" class="form-label">Total Time:</label>
                <input type="text" id="totalTime" class="form-control" value="25:00">
            </div>
            <div class="mb-3">
                <label for="yellowTime" class="form-label">Yellow Warning Time:</label>
                <input type="text" id="yellowTime" class="form-control" value="10:00">
            </div>
            <div class="mb-3">
                <label for="redTime" class="form-label">Red Warning Time:</label>
                <input type="text" id="redTime" class="form-control" value="5:00">
            </div>
        </div>

        <div id="timerDisplay" class="mb-4">
            <h1 id="timerText">25:00</h1>
            <h2 id="overtimeText">+0:00</h2>
        </div>

        <div id="controls" class="mb-4">
            <button id="playPauseButton" class="btn-icon">
                <img src="play.svg" alt="Play">
            </button>
            <button id="stopButton" class="btn-icon" disabled>
                <img src="stop.svg" alt="Stop">
            </button>
        </div>

        <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get references to DOM elements
        const totalTimeInput = document.getElementById('totalTime');
        const yellowTimeInput = document.getElementById('yellowTime');
        const redTimeInput = document.getElementById('redTime');
        const timerText = document.getElementById('timerText');
        const overtimeText = document.getElementById('overtimeText');
        const playPauseButton = document.getElementById('playPauseButton');
        const stopButton = document.getElementById('stopButton');
        const progressBar = document.getElementById('progressBar');
        const aboutButton = document.getElementById('aboutButton');

        // Variables for timing
        let totalTimeInMillis = 0;
        let yellowWarningTimeInMillis = 0;
        let redWarningTimeInMillis = 0;
        let startTimeInMillis = 0;
        let isRunning = false;
        let isPaused = false;
        let pausedTimeOffset = 0;
        let overtimeStartInMillis = 0;
        let pausedOvertimeOffset = 0;
        let timerInterval = null;

        // On window load, load preferences and reset timer state
        window.onload = function() {
            loadPreferences();
            resetTimerState();
            stopButton.disabled = true;

            // Set up event listeners
            playPauseButton.addEventListener('click', handlePlayPause);
            stopButton.addEventListener('click', handleStop);

            // Set up input event listeners for immediate preference update
            setupInputListeners();

            // About button
            aboutButton.addEventListener('click', function() {
                alert('Presentation Timer\nVersion 1.0');
            });
        };

        function loadPreferences() {
            totalTimeInput.value = getCookie('totalTime') || '25:00';
            yellowTimeInput.value = getCookie('yellowTime') || '10:00';
            redTimeInput.value = getCookie('redTime') || '5:00';
        }

        function savePreferences() {
            setCookie('totalTime', totalTimeInput.value, 365);
            setCookie('yellowTime', yellowTimeInput.value, 365);
            setCookie('redTime', redTimeInput.value, 365);
        }

        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days*24*60*60*1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        function resetTimerState() {
            startTimeInMillis = 0;
            isRunning = false;
            isPaused = false;
            pausedTimeOffset = 0;
            overtimeStartInMillis = 0;
            pausedOvertimeOffset = 0;

            // Update the total time to the user input
            totalTimeInMillis = parseTimeInput(totalTimeInput.value);
            updateTimerUI(totalTimeInMillis);

            // Hide the overtime text
            overtimeText.style.display = 'none';

            // Reset background and progress bar
            document.body.style.backgroundColor = '#4CAF50'; // Green color
            progressBar.value = 0;

            playPauseButton.querySelector('img').src = 'play.svg';
        }

        function parseTimeInput(timeStr) {
            try {
                if (!timeStr) return 0;
                let parts = timeStr.split(':');
                let hours = 0, minutes = 0, seconds = 0;
                if (parts.length === 3) {
                    hours = parseInt(parts[0]);
                    minutes = parseInt(parts[1]);
                    seconds = parseInt(parts[2]);
                } else if (parts.length === 2) {
                    minutes = parseInt(parts[0]);
                    seconds = parseInt(parts[1]);
                } else if (parts.length === 1) {
                    seconds = parseInt(parts[0]);
                }
                return ((hours * 3600) + (minutes * 60) + seconds) * 1000;
            } catch (e) {
                return 0;
            }
        }

        function updateTimerUI(millis) {
            if (millis <= 0) {
                millis = totalTimeInMillis;
            }
            timerText.textContent = formatTime(millis);

            // Update the progress bar
            let progress = ((totalTimeInMillis - millis + 1000) * 100) / totalTimeInMillis;
            progressBar.value = progress;
        }

        function formatTime(millis) {
            let totalSeconds = Math.floor(millis / 1000);
            let hours = Math.floor(totalSeconds / 3600);
            let minutes = Math.floor((totalSeconds % 3600) / 60);
            let seconds = totalSeconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            } else if (minutes > 0) {
                return `${minutes}:${seconds.toString().padStart(2,'0')}`;
            } else {
                return `${seconds}`;
            }
        }

        function setupInputListeners() {
            function onInputChanged() {
                savePreferences();
                totalTimeInMillis = parseTimeInput(totalTimeInput.value);
                updateTimerUI(totalTimeInMillis);
            }

            totalTimeInput.addEventListener('input', onInputChanged);
            yellowTimeInput.addEventListener('input', onInputChanged);
            redTimeInput.addEventListener('input', onInputChanged);
        }

        function handlePlayPause() {
            if (!isRunning) {
                if (!parseAndValidateInput()) return;
                startTimer();
            } else {
                if (isPaused) {
                    resumeTimer();
                } else {
                    pauseTimer();
                }
            }
        }

        function parseAndValidateInput() {
            totalTimeInMillis = parseTimeInput(totalTimeInput.value);
            yellowWarningTimeInMillis = parseTimeInput(yellowTimeInput.value);
            redWarningTimeInMillis = parseTimeInput(redTimeInput.value);

            if (totalTimeInMillis <= 0) {
                alert('Total time must be greater than zero.');
                return false;
            }

            // If red warning time is 0 or empty, set it to trigger right before the timer ends
            if (redWarningTimeInMillis === 0) {
                redWarningTimeInMillis = 1;
            }

            if (redWarningTimeInMillis >= yellowWarningTimeInMillis) {
                alert('Red warning time must be less than yellow warning time.');
                return false;
            }

            if (yellowWarningTimeInMillis >= totalTimeInMillis || redWarningTimeInMillis >= totalTimeInMillis) {
                alert('Warning times must be less than the total time.');
                return false;
            }

            return true;
        }

        function startTimer() {
            startTimeInMillis = Date.now() - pausedTimeOffset;
            isRunning = true;
            isPaused = false;
            pausedTimeOffset = 0;
            savePreferences();

            playPauseButton.querySelector('img').src = 'pause.svg';
            stopButton.disabled = false;
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            let elapsedMillis = Date.now() - startTimeInMillis;
            let remainingTime = totalTimeInMillis - elapsedMillis;

            if (remainingTime > 0) {
                updateTimerUI(remainingTime);

                // Handle color changes based on remaining time
                if (remainingTime <= redWarningTimeInMillis) {
                    document.body.style.backgroundColor = '#F44336'; // Red
                } else if (remainingTime <= yellowWarningTimeInMillis) {
                    document.body.style.backgroundColor = '#FF9800'; // Orange
                } else {
                    document.body.style.backgroundColor = '#4CAF50'; // Green
                }
            } else {
                // When the timer hits 0, explicitly change the background to red
                if (overtimeStartInMillis === 0) {
                    document.body.style.backgroundColor = '#F44336'; // Ensure red color at time 0
                    overtimeStartInMillis = Date.now();

                    // Show the overtime text
                    overtimeText.style.display = 'block';
                    overtimeText.style.opacity = '1';
                }

                // Update overtime
                let overtimeElapsed = Date.now() - overtimeStartInMillis;
                updateOvertimeUI(overtimeElapsed);
            }
        }

        function updateOvertimeUI(millis) {
            overtimeText.textContent = '+' + formatTime(millis);
        }

        function pauseTimer() {
            isPaused = true;
            pausedTimeOffset = Date.now() - startTimeInMillis;

            // If we are in overtime, calculate and store the paused overtime offset
            if (overtimeStartInMillis > 0) {
                pausedOvertimeOffset = Date.now() - overtimeStartInMillis;
            }

            playPauseButton.querySelector('img').src = 'play.svg';
            clearInterval(timerInterval);
            savePreferences();
        }

        function resumeTimer() {
            if (overtimeStartInMillis > 0) {
                // Adjust the overtime start time using the paused overtime offset
                overtimeStartInMillis = Date.now() - pausedOvertimeOffset;
                pausedOvertimeOffset = 0;
            }

            startTimer(); // Restart using the system time and offset
        }

        function handleStop() {
            stopTimer();
            resetTimerState();
        }

        function stopTimer() {
            isRunning = false;
            isPaused = false;
            startTimeInMillis = 0;
            pausedTimeOffset = 0;
            overtimeStartInMillis = 0;
            pausedOvertimeOffset = 0;

            // Reset UI elements
            playPauseButton.querySelector('img').src = 'play.svg';
            stopButton.disabled = true;
            clearInterval(timerInterval);

            // Reset background and progress bar
            document.body.style.backgroundColor = '#4CAF50';
            progressBar.value = 0;

            // Hide the overtime text
            overtimeText.style.display = 'none';

            updateTimerUI(0);

            savePreferences();
        }

        // Hide keyboard when clicking outside inputs (optional)
        document.addEventListener('click', function(event) {
            let isClickInside = totalTimeInput.contains(event.target) ||
                                yellowTimeInput.contains(event.target) ||
                                redTimeInput.contains(event.target);

            if (!isClickInside) {
                totalTimeInput.blur();
                yellowTimeInput.blur();
                redTimeInput.blur();
            }
        });
    </script>
</body>
</html>

